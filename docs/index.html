<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>stoQ: Analysis. Simplified. &mdash; stoQ 0.9.6 documentation</title>
    <meta name="description" content="">
    <meta name="author" content="">

    

<link rel="stylesheet" href="_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" id="current-theme" href="_static/css/bootstrap3/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" id="current-adjust-theme" type="text/css" />

<link rel="stylesheet" href="_static/css/font-awesome.min.css">

<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
</style>

<link rel="stylesheet" href="_static/css/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    './',
            VERSION:     '0.9.6',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
    <script type="text/javascript" src="_static/js/jquery.min.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap3.min.js"></script>
<script type="text/javascript" src="_static/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="_static/js/basicstrap.js"></script>
<script type="text/javascript">
</script>
    <link rel="top" title="stoQ 0.9.6 documentation" href="#" />
    <link rel="next" title="Installing" href="Installation.html" /> 
  </head>
  <body role="document">
    <div id="navbar-top" class="navbar navbar-fixed-top navbar-default" role="navigation" aria-label="top navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">stoQ 0.9.6 documentation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
              <li class="dropdown visible-xs">
                <a role="button" id="localToc" data-toggle="dropdown" data-target="#" href="#">Table Of Contents <b class="caret"></b></a>
                <ul class="dropdown-menu localtoc sp-localtoc" role="menu" aria-labelledby="localToc">
                <ul>
<li><a class="reference internal" href="#">stoQ: Analysis. Simplified.</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#basic-usage-via-interactive-shell">Basic Usage via Interactive Shell</a></li>
<li><a class="reference internal" href="#basic-usage-via-command-line">Basic Usage via Command Line</a></li>
<li><a class="reference internal" href="#using-the-queues">Using the queues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>

                </ul>
              </li>

            
              <li><a href="Installation.html" title="Installing" accesskey="N">next </a></li>
              <li><a href="py-modindex.html" title="Python Module Index" >modules </a></li>
              <li><a href="genindex.html" title="General Index" accesskey="I">index </a></li>
            
            <li class="visible-xs"><a href="_sources/index.txt" rel="nofollow">Show Source</a></li>

            <li class="visible-xs">
                <form class="search form-search form-inline navbar-form navbar-right sp-searchbox" action="search.html" method="get">
                  <div class="input-append input-group">
                    <input type="text" class="search-query form-control" name="q" placeholder="Search...">
                    <span class="input-group-btn">
                    <input type="submit" class="btn" value="Go" />
                    </span>
                  </div>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </li>

            

          </ul>

        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">

      <!-- row -->
      <div class="row">
         
<div class="col-md-3 hidden-xs" id="sidebar-wrapper">
  <div class="sidebar hidden-xs" role="navigation" aria-label="main navigation">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">stoQ: Analysis. Simplified.</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#basic-usage-via-interactive-shell">Basic Usage via Interactive Shell</a></li>
<li><a class="reference internal" href="#basic-usage-via-command-line">Basic Usage via Command Line</a></li>
<li><a class="reference internal" href="#using-the-queues">Using the queues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>

  <h4>Next topic</h4>
  <p class="topless"><a href="Installation.html"
                        title="next chapter">Installing</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" role="search">
  <h3>Quick search</h3>
  <form class="search form-inline" action="search.html" method="get">
      <div class="input-append input-group">
        <input type="text" class="search-query form-control" name="q" placeholder="Search...">
        <span class="input-group-btn">
        <input type="submit" class="btn" value="Go" />
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div> 
        

        <div class="col-md-9" id="content-wrapper">
          <div class="document" role="main">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <div class="section" id="stoq-analysis-simplified">
<h1>stoQ: Analysis. Simplified.<a class="headerlink" href="#stoq-analysis-simplified" title="Permalink to this headline">¶</a></h1>
<p>Quick Links</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="PluginDevelopment.html">Plugin Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dispatcher.html">Dispatcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="Stoq.html">Stoq</a></li>
<li class="toctree-l1"><a class="reference internal" href="Args.html">StoqArgs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Plugins.html">StoqPluginManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="Scan.html">StoqScan</a></li>
<li class="toctree-l1"><a class="reference internal" href="Filters.html">StoqBloomFilter</a></li>
<li class="toctree-l1"><a class="reference internal" href="Shell.html">StoqShell</a></li>
</ul>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><strong>stoQ</strong> is a modular and highly customizable framework for the creation of data
sets from multiple disparate data sources. <strong>stoQ</strong> leverages RabbitMQ in order
to allow for a scalable and distributed architecture. The framework can be
quickly and easily extended by utilizing the <em>Plugin</em> architecture. Output from
the framework can be modified for human presentation using <strong>stoQ</strong>&#8216;s builtin
templating engine</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p><strong>stoQ</strong> can be run in several modes to include interactive shell, single file,
entire directories, monitoring directories for new files, and queue mode.
Let&#8217;s go over some of the simplest ways of using <strong>stoQ</strong>.</p>
<div class="section" id="basic-usage-via-interactive-shell">
<h3>Basic Usage via Interactive Shell<a class="headerlink" href="#basic-usage-via-interactive-shell" title="Permalink to this headline">¶</a></h3>
<p><strong>stoQ</strong> provides a simply interactive shell interface. This interface is
designed to allow a user to interact with <strong>stoQ</strong> and <strong>stoQ</strong> plugins on
a much more granular level than via the command line.</p>
<p>To enter the interactive shell, simply run <strong>stoQ</strong> with the <code class="docutils literal"><span class="pre">shell</span></code>
argument.:</p>
<div class="highlight-python"><div class="highlight"><pre>bash$ ./stoq-cli.py shell

    _______ _________ _______  _______
    (  ____ \__   __/(  ___  )(  ___  )
    | (    \/   ) (   | (   ) || (   ) |
    | (_____    | |   | |   | || |   | |
    (_____  )   | |   | |   | || |   | |
          ) |   | |   | |   | || | /\| |
    /\____) |   | |   | (___) || (_\ \ |
    \_______)   )_(   (_______)(____\/_)

            Analysis. Simplified.


[stoQ] &gt;
</pre></div>
</div>
<p>Once in the interactive shell, you can run the <code class="docutils literal"><span class="pre">help</span></code> command for a
complete listing of available commands. Please view the <a class="reference internal" href="Shell.html"><em>StoqShell</em></a> documentation
for a more exhaustive list of directions.</p>
</div>
<div class="section" id="basic-usage-via-command-line">
<h3>Basic Usage via Command Line<a class="headerlink" href="#basic-usage-via-command-line" title="Permalink to this headline">¶</a></h3>
<p>In order to use <strong>stoQ</strong> via the command line, at least two options must be
defined. The worker plugin that should be loaded, and the source of input.
In order to see a basic usage help, simply execute <code class="docutils literal"><span class="pre">stoq-cli.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>bash$ stoq-cli.py

    .------..------..------..------.
    |S.--. ||T.--. ||O.--. ||Q.--. |
    | :/\: || :/\: || :/\: || (\/) |
    | :\/: || (__) || :\/: || :\/: |
    | &#39;--&#39;S|| &#39;--&#39;T|| &#39;--&#39;O|| &#39;--&#39;Q|
    `------&#39;`------&#39;`------&#39;`------&#39;

usage:
    stoq-cli.py [command] [&lt;args&gt;]

    Available Commands:
        help    Display help message
        shell   Launch an interactive shell
        list    List plugins available
        worker  Load specified worker plugin
        install Install a stoQ plugin
</pre></div>
</div>
<p>To view a complete listing of available plugins simply call <code class="docutils literal"><span class="pre">stoq-cli.py</span></code> with the
<code class="docutils literal"><span class="pre">list</span></code> command line argument:</p>
<div class="highlight-python"><div class="highlight"><pre>bash$ stoq-cli.py list

    _______ _______  _____   _____
    |______    |    |     | |   __|
    ______|    |    |_____| |____\|

Available Plugins:
connectors
    - file                v0.9    Retrieves and saves content to local disk
    - stdout              v0.9    Sends content to STDOUT
extractors
    - decompress          v0.9    Extract content from a multitude of archive formats
    - gpg                 v0.1    Handle GnuPG encrypted content
readers
    - iocregex            v0.9    Regex routines to extract and normalize IOC&#39;s from a payload
carvers
    - ole                 v0.9    Carve OLE streams within Microsoft Office Documents
    - pe                  v0.9    Carve portable executable files from a data stream
    - rtf                 v0.9    Carve hex/binary streams from RTF payloads
    - swf                 v0.9    Carve and decompress SWF payloads
    - xdp                 v0.9    Carve and decode streams from XDP documents
workers
    - censys              v0.1    Interact with Censys.io API
    - exif                v0.9    Processes a payload using ExifTool
    - peinfo              v0.9    Gather relevant information about an executable using pefile
    - publisher           v0.9    Publish messages to single or multiple RabbitMQ queues for processing
    - threatcrowd         v0.1    Interact with ThreatCrowd API
    - yara                v0.9    Process a payload using yara
decoders
    - b64                 v0.1    Decode base64 encoded content
    - b85                 v0.1    Decode base85 encoded content
    - bitwise_rotate      v0.1    Rotate bits left or right. Defaults to 4 bits right for nibble swapping.
    - rot47               v0.1    Decode ROT47 encoded content
    - xor                 v0.1    Decode XOR encoded content
sources
    - dirmon              v0.9    Monitor a directory for newly created files for processing
    - filedir             v0.9    Ingest a file or directory for processing
</pre></div>
</div>
<p>Now that we have a complete listing of available worker and connector plugins,
we can begin processing data. Let&#8217;s say that we have a file named <em>bad.exe</em> that we want to
process with the <em>yara</em> worker plugin. We also want the results to be displayed to our console.
We can simply run <strong>stoQ</strong> with the following command line arguments:</p>
<div class="highlight-python"><div class="highlight"><pre>bash$ stoq-cli.py yara -F bad.exe
{
&quot;date&quot; : &quot;2015-10-29T15:22:55.824563&quot;,
&quot;payloads&quot; : 1,
&quot;results&quot; : [ {
        &quot;md5&quot; : &quot;0ace1c67d408986ca60cd52272dc8d35&quot;,
        &quot;payload_id&quot; : 0,
        &quot;plugin&quot; : &quot;yara&quot;,
        &quot;scan&quot; : [ {&quot;hits&quot; : [ {
                        &quot;matches&quot; : true,
                        &quot;meta&quot; : {
                                &quot;author&quot; : &quot;PUNCH Cyber Analytics Group&quot;,
                                &quot;cve&quot; : &quot;N/A&quot;,
                                &quot;description&quot; : &quot;Badness&quot;,
                                &quot;type&quot; : &quot;Suspicious String&quot;,
                                &quot;version&quot; : &quot;1.0&quot;,
                                &quot;weight&quot; : 100
                                },
                        &quot;namespace&quot; : &quot;default&quot;,
                        &quot;rule&quot; : &quot;win_api_LoadLibrary&quot;,
                        &quot;strings&quot; : [
                                [
                                    &quot;23967&quot;,
                                    &quot;$LoadLibrary&quot;,
                                    &quot;b&#39;LoadLibrary&#39;&quot;
                                ],
                            ],
                        &quot;tags&quot; : [  ]
                        } ],
                    }
                ],
        &quot;sha1&quot; : &quot;5a04547c1c56064855c3c6426448d67ccc1e0829&quot;,
        &quot;sha256&quot; : &quot;458f1bb61b7ef167467228141ad44295f3425fbeb6303e9d31607097d6869932&quot;,
        &quot;sha512&quot; : &quot;c5dbd244d186546846c25a393edeafdd6604e2a2e04e021a21d0524f7b02d3ecb85c12dba252a11a3bb01c20fb736ca6153e055eef2cf1bc2f15fea667f2fce4&quot;,
        &quot;size&quot; : 55208,
        &quot;uuid&quot; : &quot;da8215ed-89ca-43db-8c96-a8b8231f6a5e&quot;
    } ]
}
</pre></div>
</div>
<p>We can easily change the method the results are handled by modifying the <code class="docutils literal"><span class="pre">-C</span></code>
flag. Simply replace <code class="docutils literal"><span class="pre">stdout</span></code> with another plugin name, such as <code class="docutils literal"><span class="pre">file</span></code> or
<code class="docutils literal"><span class="pre">mongodb</span></code>. The default <em>connector</em> plugin may also be changed by changing
the <code class="docutils literal"><span class="pre">output_connector</span></code> option in <em>stoq.cfg</em>.</p>
<p>Additionally, output can be customized using <strong>stoQ</strong>&#8216;s templating engine.</p>
</div>
<div class="section" id="using-the-queues">
<h3>Using the queues<a class="headerlink" href="#using-the-queues" title="Permalink to this headline">¶</a></h3>
<p>Queues enable <strong>stoQ</strong> to process payloads in a ditributed and scalable manner.
In this use case, we will utilize the <em>publisher</em> worker plugin with RabbitMQ.
The <em>publisher</em> worker plugin&#8217;s primary purpose is to handle files to be ingested,
and then notify the other worker plugins that there is a file that is ready to
be processed. By default, the <em>publisher</em> worker plugin will notify each of the
worker plugins that are defined in <em>publisher.stoq</em>. This can be easily
modified at run time by defining one or many <code class="docutils literal"><span class="pre">-w</span></code> command line arguments for
the <em>publisher</em>. For now, we will assume that the default worker queues
(<em>yara, exif, peinfo, trid</em>) are sufficient.</p>
<p>Let&#8217;s assume that we have a directory in our current working directory named
<em>malicious</em>. We want to monitor this directory, using the dirmon source plugin,
for any new files that are created, archive them to MongoDB, and then process
them with our default workers listed above:</p>
<div class="highlight-python"><div class="highlight"><pre>bash$ stoq-cli.py publisher -I dirmon -F malicious -A mongodb
</pre></div>
</div>
<p>Once a file is placed into this directory, the newly created file will be
ingested, saved into our MongoDB instance, and a message will be sent to the
appropriate queues for processing.</p>
<p>Now, we need to make sure our worker plugins are running so they can processes
their newly identified file. In this scenario, since we are saving the file
itself into MongoDB, we will also save our worker plugin results into MongoDB:</p>
<div class="highlight-python"><div class="highlight"><pre>bash$ stoq-cli.py yara -I rabbitmq -C mongodb &amp;
bash$ stoq-cli.py exif -I rabbitmq -C mongodb &amp;
bash$ stoq-cli.py peinfo -I rabbitmq -C mongodb &amp;
bash$ stoq-cli.py trid -I rabbitmq -C mongodb &amp;
</pre></div>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h2>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span>Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span>Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span>Search Page</span></a></li>
</ul>
</div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row footer-relbar">
<div id="navbar-related" class=" related navbar navbar-default" role="navigation" aria-label="related navigation">
  <div class="navbar-inner">
    <ul class="nav navbar-nav ">
        <li><a href="#">stoQ 0.9.6 documentation</a></li>
    </ul>
<ul class="nav navbar-nav pull-right hidden-xs hidden-sm">
      
        <li><a href="Installation.html" title="Installing" >next</a></li>
        <li><a href="py-modindex.html" title="Python Module Index" >modules</a></li>
        <li><a href="genindex.html" title="General Index" >index</a></li>
        <li><a href="#">top</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer role="contentinfo">
          &copy; Copyright 2014-2015, PUNCH Cyber Analytics Group.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>